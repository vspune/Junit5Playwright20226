pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9'
        jdk 'JDK-11'
        allure 'Allure'
    }
    
    triggers {
        githubPush()
    }
    
    environment {
        ENVIRONMENT = 'qa'
        HEADLESS = 'true'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo "ğŸ“¦ Checking out code..."
                checkout scm
            }
        }
       
        stage('Build') {
            steps { 
                echo "ğŸ”¨ Compiling project..."
                bat 'mvn clean compile' 
            }
        }

        stage('Install Playwright') {
            steps {
                echo "ğŸ­ Installing Playwright browsers..."
                bat 'mvn exec:java -e -D exec.mainClass=com.microsoft.playwright.CLI -D exec.args="install"'
            }
        }
        
        // ========================================
        // âœ… PARALLEL EXECUTION STARTS HERE
        // ========================================
        stage('Run Tests in Parallel') {
            parallel {
                // ========================================
                // Stage 1: Login Tests
                // ========================================
                stage('Chrome Login , Home Tests') {
                    steps {
                        echo "ğŸ” Running Login tests in PARALLEL..."
                        bat """
                            mvn verify ^
                                -Dgroups="LoginPage | HomePage" ^
                                -Denv=%ENVIRONMENT% ^
                                -Dbrowser=chromium ^
                                -Dheadless=%HEADLESS% ^
                                -Dallure.results.directory=target/allure-results/chrome
                        """
                    }
                }
                
                // ========================================
                // Stage 2: Home Tests
                // ========================================
                stage('FireFox Login , Home Tests') {
                    steps {
                        echo "ğŸ  Running Home tests in PARALLEL..."
                        bat """
                            mvn verify ^
                                -Dgroups="LoginPage | HomePage" ^
                                -Denv=%ENVIRONMENT% ^
                                -Dbrowser=firefox ^
                                -Dheadless=%HEADLESS% ^
                                -Dallure.results.directory=target/allure-results/firefox
                        """
                    }
                }
            }
        }
        
        // ========================================
        // Aggregate Allure Results
        // ========================================
        stage('Aggregate Results') {
            steps {
                echo "ğŸ“Š Merging test results from all parallel stages..."
                bat """
                    if not exist target\\allure-results-merged mkdir target\\allure-results-merged
                    xcopy target\\allure-results\\login\\*.* target\\allure-results-merged\\ /E /I /Y 2>nul
                    xcopy target\\allure-results\\home\\*.* target\\allure-results-merged\\ /E /I /Y 2>nul
                """
            }
        }
    }
    
    post {
        success {
            echo "âœ… All parallel tests passed!"
        }
        failure {
            echo "âŒ Some tests failed - check Allure report"
        }
        always {
            echo "ğŸ“Š Generating Allure report..."
            allure([
                includeProperties: false,
                jdk: '',
                results: [[path: 'target/allure-results-merged']]
            ])
            cleanWs()
        }
    }
}